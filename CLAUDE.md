# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを扱う際のガイダンスを提供します。

## プロジェクト概要

PHP、CSS、JavaScriptで作成された高機能アンケートシステムです。
条件分岐機能、複数質問タイプ、URLパラメータ統合、回答分析機能を持つ本格的なWebアプリケーションです。
サーバーサイドでのデータ永続化、複数画面での機能分離、リアルタイムバリデーションを実装しています。

## システム機能一覧

### アンケート作成・管理機能
- **ドラッグ&ドロップ質問追加**: 直感的なUIで質問を追加
- **8種類の質問タイプ**:
  - 一行テキスト
  - 複数行テキスト（textarea）
  - メールアドレス（バリデーション付き）
  - ラジオボタン
  - チェックボックス
  - ドロップダウンリスト
  - ラベル（情報表示専用）
  - パラメータ（URLパラメータ自動取得）
- **条件分岐機能**: 回答に応じた動的質問表示
- **質問順序変更**: ドラッグ&ドロップによる並び替え
- **必須回答設定**: 質問単位での必須設定
- **リアルタイムプレビュー**: 作成中の確認機能

### アンケート配布・回答機能
- **公開/非公開切り替え**: ワンクリックでの状態変更
- **URLコピー機能**: 回答ページへの直接リンク
- **QRコード生成**: モバイル回答用
- **レスポンシブデザイン**: 全デバイス対応
- **URLパラメータ統合**: 外部システムからのデータ自動取得
- **条件分岐による動的表示**: 回答に応じたリアルタイム質問制御
- **包括的バリデーション**: フロントエンド・バックエンド両方

### 回答分析・管理機能
- **統計ダッシュボード**: 回答数、完答率、最新回答日時
- **質問別分析**:
  - 選択式質問: 円グラフ・棒グラフによる統計表示
  - テキスト質問: 回答一覧表示
- **個別回答詳細**: 回答者単位での詳細表示
- **検索・フィルター**: 日付範囲、キーワード検索
- **CSVエクスポート**: Excel等での分析用データ出力
- **回答削除**: 個別・一括削除機能

### 条件分岐システム
- **演算子**: equals、contains、not_equals
- **対象質問**: 任意の質問を条件対象に設定
- **複数条件**: AND結合による複合条件
- **動的評価**: 回答変更時のリアルタイム再評価
- **必須回答制御**: 非表示質問の必須設定自動無効化

### URLパラメータ統合
- **パラメータ質問タイプ**: 非表示でのパラメータ値取得
- **カスタムパラメータ名**: 任意のパラメータ名設定
- **自動値設定**: URL解析による自動フィールド設定
- **回答データ統合**: 通常回答と同様にデータ保存

## プロジェクト構造

```
/
├── index.html              # 管理画面（初期画面）
├── create.html             # アンケート作成・編集画面
├── survey.html             # 公開アンケート回答ページ
├── responses.html          # 回答閲覧・分析ページ
├── api/                    # PHP API
│   ├── config.php          # 共通設定・関数
│   ├── surveys.php         # アンケートCRUD API
│   └── responses.php       # 回答保存・取得API
├── css/
│   └── style.css           # 共通スタイルシート
├── js/
│   ├── api.js              # API通信ライブラリ
│   ├── script.js           # アンケート作成・編集用
│   ├── manage.js           # 管理画面用
│   └── responses.js        # 回答閲覧用
└── data/
    ├── surveys.json        # アンケートデータ
    └── responses.json      # 回答データ
```

## 開発コマンド

### サーバー起動
```bash
# プロジェクトディレクトリで実行
php -S localhost:8000
```

### アクセスURL
- 管理画面: http://localhost:8000/
- 作成画面: http://localhost:8000/create.html
- 回答ページ: http://localhost:8000/survey.html?id=[アンケートID]
- 回答分析: http://localhost:8000/responses.html?id=[アンケートID]

## サイトの機能

### 1. アンケート管理（index.html）
- 保存済みアンケートの一覧表示
- 統計情報（総数、公開中、下書き、回答数）
- 検索・フィルター機能（状態、作成日、タイトル）
- 公開/非公開の切り替え
- URLコピー・QRコード生成
- 回答データへのリンク

### 2. アンケート作成・編集（create.html）
- ドラッグ&ドロップでの質問追加（全8タイプ対応）
- 質問と選択肢の編集
- 条件分岐設定（演算子、対象質問、値の設定）
- 必須質問の設定（ラベル・パラメータ除く）
- パラメータ名設定（パラメータ質問用）
- プレビュー機能
- 保存・公開機能

### 3. アンケート回答（survey.html）
- 公開アンケートへの回答
- 条件分岐による動的質問表示
- URLパラメータ自動取得・設定
- リアルタイムバリデーション（メール形式等）
- レスポンシブデザイン
- 回答データのサーバー保存

### 4. 回答分析（responses.html）
- 回答統計（総数、完答率、最新回答日時）
- 質問別分析
  - 選択式：円グラフ・棒グラフによる統計表示
  - テキスト：回答一覧表示
  - パラメータ：値の分布表示
- 個別回答の詳細表示
- 検索・日付フィルター
- CSVエクスポート（全データ型対応）
- 回答削除機能

## コードアーキテクチャ

### サーバーサイド（PHP）
- RESTful API設計
- JSONファイルでのデータ永続化
- CORS対応
- 包括的なバリデーション
- エラーハンドリング

### フロントエンド
- jQuery + 専用APIライブラリ
- 画面別JavaScriptファイル
- モーダルベースのUI
- レスポンシブデザイン
- toastrによる通知

### データ構造
```json
// surveys.json
{
  "id": "string",
  "title": "string",
  "questions": [
    {
      "id": "number",
      "type": "text|email|textarea|radio|checkbox|select|label|parameter",
      "title": "string",
      "required": "boolean",
      "options": ["string"],
      "conditions": [
        {
          "targetQuestionId": "number",
          "operator": "equals|contains|not_equals",
          "value": "string"
        }
      ],
      "parameterName": "string" // パラメータタイプのみ
    }
  ],
  "published": "boolean",
  "publicUrl": "string",
  "createdAt": "ISO8601",
  "updatedAt": "ISO8601"
}

// responses.json
{
  "id": "string",
  "surveyId": "string",
  "surveyTitle": "string",
  "answers": {
    "question_0": "string|array" // パラメータ質問も含む
  },
  "submittedAt": "ISO8601",
  "ipAddress": "string"
}
```

## 技術仕様

### サポートする質問タイプ
1. **text**: 一行テキスト入力
2. **email**: メールアドレス入力（HTML5バリデーション + 正規表現）
3. **textarea**: 複数行テキスト入力
4. **radio**: 単一選択（ラジオボタン）
5. **checkbox**: 複数選択（チェックボックス）
6. **select**: プルダウン選択
7. **label**: 情報表示専用（質問番号なし、必須設定不可）
8. **parameter**: URLパラメータ自動取得（非表示、バリデーション除外）

### 条件分岐仕様
- **対象**: 任意の質問を条件対象に設定可能
- **演算子**:
  - `equals`: 完全一致（選択式で選択肢が含まれるかチェック）
  - `contains`: 部分一致（テキスト内に値が含まれるかチェック）
  - `not_equals`: 不一致
- **複数条件**: AND結合で複数条件設定可能
- **動的評価**: 回答変更時にリアルタイムで再評価
- **必須制御**: 非表示になった必須質問は自動的に必須設定解除

### URLパラメータ統合仕様
- **パラメータ質問**: `type: "parameter"` で設定
- **パラメータ名**: `parameterName` プロパティで指定
- **URL例**: `survey.html?id=123&source=email&campaign=summer`
- **自動設定**: ページ読み込み時にURLパラメータを解析して隠しフィールドに設定
- **回答統合**: 通常の回答データと同様に保存・分析対象

### バリデーション仕様
- **フロントエンド**: HTML5 + カスタムJavaScript
- **バックエンド**: PHP APIでの包括的チェック
- **メール形式**: 正規表現 `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
- **必須チェック**: 表示中の質問のみ対象
- **条件分岐考慮**: 非表示質問は必須でもバリデーション除外

## ファイル編集ガイドライン

### 新機能追加時
1. **API機能**: `api/`フォルダ内のPHPファイルを編集
2. **フロントエンド**: 対応する画面のJavaScriptファイルを編集
3. **共通機能**: `js/api.js`にAPIクライアント関数を追加
4. **スタイル**: `css/style.css`を編集

### 開発時の注意点
- データ型の一貫性（IDは文字列として扱う）
- 条件分岐ロジックの整合性確保
- パラメータ質問の特殊処理対応
- エラーハンドリングの実装
- ユーザーフィードバック（toastr）の提供
- レスポンシブデザインの維持
- 日本語コンテンツの一貫性

### セキュリティ考慮事項
- 入力値のバリデーション（フロント・バック両方）
- XSS対策（HTMLエスケープ）
- パラメータインジェクション対策
- 公開状態の確認
- 適切なHTTPステータスコード

## API仕様

### アンケートAPI（/api/surveys.php）
- `GET`: 全アンケート取得
- `GET ?id=`: 特定アンケート取得
- `POST`: 新規アンケート作成
- `PUT`: アンケート更新
- `DELETE`: アンケート削除

### 回答API（/api/responses.php）
- `POST`: 回答データ保存（条件分岐考慮したバリデーション）
- `GET ?surveyId=`: 特定アンケートの回答一覧取得

### 条件分岐処理
- フロントエンド: `evaluateAllConditions()` - リアルタイム評価
- バックエンド: `evaluateQuestionConditions()` - 回答保存時評価
- 必須項目制御: 非表示質問の必須設定自動解除

## トラブルシューティング

### 権限エラー
```bash
chmod 755 data/
chmod 644 data/*.json
```

### PHPエラー
- `error.log`を確認
- ブラウザの開発者ツールでNetworkタブを確認

### データが表示されない
- APIレスポンスをブラウザで直接確認
- JavaScript コンソールエラーを確認